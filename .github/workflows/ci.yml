name: CI - Marketing Data Platform

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint-and-test:
    name: Lint and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pylint pytest pytest-cov
    
    - name: Lint Python code
      run: |
        pylint src/ --disable=C0114,C0115,C0116 --max-line-length=120 || true
        pylint dags/ --disable=C0114,C0115,C0116,E0401 --max-line-length=120 || true
    
    - name: Run unit tests
      run: |
        PYTHONPATH=src pytest tests/unit/ -v --cov=src --cov-report=term-missing
    
    - name: Validate DAGs syntax
      run: |
        python scripts/validate_dags.py
    
  dbt-checks:
    name: dbt Validation
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dbt
      run: |
        pip install dbt-bigquery==1.7.0
    
    - name: dbt deps
      run: |
        cd dbt/mdp
        dbt deps --profiles-dir .
    
    - name: dbt compile
      run: |
        cd dbt/mdp
        dbt compile --profiles-dir . --target dev || echo "Compilation check completed"
    
    - name: dbt parse
      run: |
        cd dbt/mdp
        dbt parse --profiles-dir . || echo "Parse check completed"
